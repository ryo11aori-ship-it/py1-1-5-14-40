name: Test py1 Compiler & Self-Hosting

on: [push, pull_request]

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  PYTHONUNBUFFERED: 1

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Setup Locale
      run: |
        sudo locale-gen ja_JP.UTF-8
        sudo update-locale LANG=ja_JP.UTF-8
        export LANG=ja_JP.UTF-8
        export LC_ALL=ja_JP.UTF-8

    - name: Install Black
      run: pip install black

    # 1. ブートストラップ
    - name: 1. Bootstrap Generation 1
      run: |
        python py1.py compiler.py1 > compiler_gen2.py
        black compiler_gen2.py

    # 2. セルフホスト
    - name: 2. Bootstrap Generation 2
      run: |
        python compiler_gen2.py compiler.py1 > compiler_gen3.py
        black compiler_gen3.py

    # 3. 厳密な同一性検証 (SHA256)
    - name: 3. Verify Strict Idempotency (SHA256)
      run: |
        echo "--- Calculating SHA256 Checksums ---"
        sha256sum compiler_gen2.py > gen2.sha256
        sha256sum compiler_gen3.py > gen3.sha256
        
        cat gen2.sha256
        cat gen3.sha256
        
        # ハッシュ値のみを抽出して比較
        HASH2=$(cut -d ' ' -f 1 gen2.sha256)
        HASH3=$(cut -d ' ' -f 1 gen3.sha256)
        
        if [ "$HASH2" = "$HASH3" ]; then
          echo "SUCCESS: Byte-level reproducibility achieved."
        else
          echo "FAILURE: Checksums do not match."
          exit 1
        fi

    # 4. FizzBuzz (Python Transpilation)
    - name: 4. Application Test (FizzBuzz - Python)
      run: |
        python compiler_gen3.py fizzbuzz.py1 > output_fb.py
        python output_fb.py

    # 5. Unicodeテスト
    - name: 5. Unicode Test
      env:
        LANG: ja_JP.UTF-8
        LC_ALL: ja_JP.UTF-8
      run: |
        python compiler_gen3.py unicode_test.py1 > output_uni.py
        python output_uni.py

    # 6. IRコンパイラのコンパイルと実行
    - name: 6. IR Compilation (FizzBuzz IR)
      run: |
        python compiler_gen3.py compiler_ir.py1 > compiler_ir.py
        python compiler_ir.py fizzbuzz_while.py1 > fizzbuzz.ir
        cat fizzbuzz.ir

        # ... (前略)

    # 7. ネイティブVM (C言語) のビルドと実行
    - name: 7. Native VM Execution (C Implementation)
      run: |
        echo "--- Compiling VM in C ---"
        gcc -o vm vm.c
        
        echo "--- Executing FizzBuzz on Native VM ---"
        ./vm fizzbuzz.ir

        # ... (前略)

    # 8. 機能テスト
    - name: 8. Feature Test (List/Dict/Methods)
      run: |
        python compiler_ir.py feature_test.py1 > features.ir
        ./vm features.ir

    # 9. Lexer Test (Minimal)
        # 9. Lexer Test (Minimal)
    - name: 9. Minimal Lexer Test
      run: |
        echo "--- Compiling Lexer ---"
        python compiler_ir.py lexer.py1 > lexer.ir
        
        echo "--- DEBUG: Show Generated IR ---"
        # ここで生成された中間コードを無理やり表示させる
        cat -n lexer.ir
        
        echo "--- Running Lexer on VM ---"
        # "|| true" をつけることで、VMがクラッシュしてもエラーで止まらず、
        # ログを最後まで吐き出させて終了コード0（成功扱い）にする
        ./vm lexer.ir || true
        # ... (Step 9 まではそのまま) ...

    # 10. Phase 2: Python VM (No Loop) Prototype Test
    - name: 10. Phase 2 VM Prototype
      run: |
        echo "--- Compiling VM Prototype ---"
        # py1コンパイラ(gen3)を使って、py1コードをPythonコードに変換
        python compiler_gen3.py vm_step.py1 > vm_step.py
        
        echo "--- Running VM Prototype ---"
        python vm_step.py
        
    # 11. Phase 2.5: VM Jump & Loop Test
    - name: 11. VM Jump Test
      run: |
        echo "--- Compiling VM Jump ---"
        python compiler_gen3.py vm_jump.py1 > vm_jump.py
        
        echo "--- Running VM Jump ---"
        python vm_jump.py

    # 12. Phase 2.5: VM Full (FizzBuzz)
    - name: 12. VM Full FizzBuzz
      run: |
        echo "--- Compiling VM Full ---"
        python compiler_gen3.py vm_full.py1 > vm_full.py
        
        echo "--- Running VM Full ---"
        python vm_full.py
    
    # 13. Phase 3: Final py1 VM execution
    - name: 13. Phase 3 py1VM
      run: |
        echo "--- Generating FizzBuzz IR ---"
        # 念のためIRを再生成
        python compiler_ir.py fizzbuzz_while.py1 > fizzbuzz.ir
        
        echo "--- Compiling py1VM ---"
        python compiler_gen3.py py1vm.py1 > py1vm.py
        
        echo "--- Running FizzBuzz on py1VM ---"
        python py1vm.py fizzbuzz.ir
         # 14. Phase 4: REPL Build & Batch Test
    
    - name: 14. Phase 4 REPL Build
      run: |
        echo "--- Compiling py1REPL ---"
        python compiler_gen3.py py1repl.py1 > py1repl.py
        
        echo "--- Testing REPL in Batch Mode (FizzBuzz) ---"
        # ファイル引数を渡せば、従来のVMとして動くはず
        python py1repl.py fizzbuzz.ir

    # 15. Phase 5: Self-Hosting Compiler
    - name: 15. Self-Hosting Compiler
      run: |
        echo "--- Bootstrap: Compiling py1_compiler.py1 using old compiler ---"
        python compiler_gen3.py py1_compiler.py1 > py1_compiler.py
        
        echo "--- Self-Host: Compiling FizzBuzz using NEW compiler ---"
        # 新しいコンパイラ(py1_compiler.py)を使ってソースをコンパイル
        python py1_compiler.py fizzbuzz_while.py1 > fizzbuzz_new.py
        
        echo "--- Running New FizzBuzz ---"
        python fizzbuzz_new.py
       
    # 16. Phase 6: The Golden Chain (Full Self-Hosting)
    - name: 16. Final Golden Chain
      run: |
        echo "=== Step 1: Bootstrap (Start the fire) ==="
        # 旧コンパイラで、最初のpy1コンパイラ(Stage 1)を生成
        python compiler_gen3.py py1_compiler.py1 > stage1_compiler.py
        
        echo "=== Step 2: Self-Hosting (The compiler compiles itself) ==="
        # Stage 1 コンパイラを使って、自分自身(py1_compiler.py1)を再コンパイル
        # これで生まれる Stage 2 は「py1によって作られたpy1コンパイラ」となる
        python stage1_compiler.py py1_compiler.py1 > stage2_compiler.py
        
        echo "=== Step 3: Final Build (Build the REPL with the pure compiler) ==="
        # 純血の Stage 2 コンパイラを使って、REPLをコンパイル
        python stage2_compiler.py py1repl.py1 > py1repl_final.py
        
        echo "=== Step 4: Verification (Run FizzBuzz on the final REPL) ==="
        # 最終生成物が正しく動くか、FizzBuzz IRを食わせてテスト
        python py1repl_final.py fizzbuzz.ir

    # 17. Phase 1: Windows Native IR Definition & Mock Execution
    - name: 17. Windows Native IR
      run: |
        echo "--- 1. Generating WinIR Code ---"
        # py1コードとしてWinIR生成スクリプトを実行し、IRファイルを作る
        # ※本来はコンパイラがやる仕事だが、まずは仕様定義のためスクリプトで生成
        python stage2_compiler.py win_ir_spec.py1 > win_ir_gen.py
        python win_ir_gen.py > fizzbuzz_win.ir
        
        echo "--- Generated WinIR ---"
        cat fizzbuzz_win.ir
        
        echo "--- 2. Compiling Mock VM ---"
        python stage2_compiler.py vm_win_mock.py1 > vm_win_mock.py
        
        echo "--- 3. Running WinIR on Mock VM ---"
        python vm_win_mock.py fizzbuzz_win.ir




